// Generated by CoffeeScript 1.4.0
var $, Ball, Character, DomRenderComponent, Game, HighScores, KeyboardInputComponent, LevelSelect, NullInputComponent, NullRenderComponent,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

$ = Zepto;

$(function() {
  var levelSelect;
  levelSelect = new LevelSelect($('#sausis .level-select'));
  return levelSelect.start();
});

window.requestAnimationFrame = (function() {
  return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.msRequestAnimationFrame || window.oRequestAnimationFrame || function(f) {
    return window.setTimeout(f, 1e3 / 60);
  };
})();

LevelSelect = (function() {

  function LevelSelect(domElement) {
    this.domElement = domElement;
    this.gameEnded = __bind(this.gameEnded, this);

    this.highscores = new HighScores;
    true;
  }

  LevelSelect.prototype.start = function() {
    var _this = this;
    $(this.domElement).on('click', '[data-level]', function(e) {
      var level;
      level = $(e.currentTarget).data('level');
      if (_this.levelUnlocked(level)) {
        return _this.playLevel(level);
      } else {
        return alert('Locked!');
      }
    });
    this.highscores.loadScores();
    return this.show();
  };

  LevelSelect.prototype.hide = function() {
    return this.domElement.hide();
  };

  LevelSelect.prototype.show = function() {
    this.updateScores();
    return this.domElement.show();
  };

  LevelSelect.prototype.updateScores = function() {
    var _this = this;
    return this.domElement.find('[data-level]').each(function(_, e) {
      var highscore, level;
      level = $(e).data('level');
      highscore = _this.highscores.get(level);
      $(e).find('.score').text(highscore.score);
      return $(e).find('.distance').text(highscore.distance);
    });
  };

  LevelSelect.prototype.levelUnlocked = function(level) {
    return true;
  };

  LevelSelect.prototype.playLevel = function(level) {
    this.game = new Game({
      renderComponent: new DomRenderComponent($('#sausis .game')),
      inputComponent: new KeyboardInputComponent,
      endGameCallback: this.gameEnded,
      level: level
    });
    this.hide();
    return this.game.start();
  };

  LevelSelect.prototype.gameEnded = function(level, score, distance) {
    distance *= 10;
    this.highscores.set(level, score, distance);
    this.game.destroy();
    this.game = void 0;
    return this.show();
  };

  return LevelSelect;

})();

HighScores = (function() {

  function HighScores() {
    this.loadScores = __bind(this.loadScores, this);

    this.saveScores = __bind(this.saveScores, this);

    this.set = __bind(this.set, this);

    this.get = __bind(this.get, this);
    this.scores = {};
  }

  HighScores.prototype.get = function(level) {
    return this.scores[level] || {
      score: 0,
      distance: 0
    };
  };

  HighScores.prototype.set = function(level, score, distance) {
    var _base;
    (_base = this.scores)[level] || (_base[level] = {
      score: 0,
      distance: 0
    });
    if (score > this.scores[level].score) {
      this.scores[level].score = score;
    }
    if (distance > this.scores[level].distance) {
      this.scores[level].distance = distance;
    }
    return setTimeout(this.saveScores, 0);
  };

  HighScores.prototype.saveScores = function() {
    var json;
    json = JSON.stringify(this.scores);
    return localStorage.setItem('scores', json);
  };

  HighScores.prototype.loadScores = function() {
    var json;
    json = localStorage.getItem('scores');
    if (json) {
      return this.scores = JSON.parse(json);
    }
  };

  return HighScores;

})();

NullInputComponent = (function() {

  function NullInputComponent() {}

  NullInputComponent.prototype.start = function() {
    return true;
  };

  NullInputComponent.prototype.update = function() {
    return true;
  };

  NullInputComponent.prototype.moveLeft = function() {
    return false;
  };

  NullInputComponent.prototype.moveRight = function() {
    return false;
  };

  NullInputComponent.prototype.pullBall = function() {
    return false;
  };

  NullInputComponent.prototype.pushBall = function() {
    return false;
  };

  return NullInputComponent;

})();

KeyboardInputComponent = (function(_super) {

  __extends(KeyboardInputComponent, _super);

  function KeyboardInputComponent() {
    return KeyboardInputComponent.__super__.constructor.apply(this, arguments);
  }

  KeyboardInputComponent.prototype.start = function() {
    var _this = this;
    this.keys = [];
    return window.onkeydown = function(e) {
      _this.keys[e.keyCode] = true;
      if (e.keyCode === 40 || e.keyCode === 38) {
        return false;
      }
    };
  };

  KeyboardInputComponent.prototype.destroy = function() {
    return window.onkeydown = void 0;
  };

  KeyboardInputComponent.prototype.update = function() {
    this.shouldMoveLeft = this.keys[37];
    this.shouldMoveRight = this.keys[39];
    this.shouldPullBall = this.keys[40];
    this.shouldPushBall = this.keys[38];
    return this.keys = [];
  };

  KeyboardInputComponent.prototype.moveLeft = function() {
    return this.shouldMoveLeft;
  };

  KeyboardInputComponent.prototype.moveRight = function() {
    return this.shouldMoveRight;
  };

  KeyboardInputComponent.prototype.pullBall = function() {
    return this.shouldPullBall;
  };

  KeyboardInputComponent.prototype.pushBall = function() {
    return this.shouldPushBall;
  };

  return KeyboardInputComponent;

})(NullInputComponent);

NullRenderComponent = (function() {

  function NullRenderComponent() {}

  NullRenderComponent.prototype.start = function() {
    return true;
  };

  NullRenderComponent.prototype.update = function() {
    return true;
  };

  NullRenderComponent.prototype.updateScore = function(score) {
    return true;
  };

  NullRenderComponent.prototype.updateTimer = function(time, totalTime) {
    return true;
  };

  NullRenderComponent.prototype.buildGameBoard = function() {
    return true;
  };

  NullRenderComponent.prototype.buildColumn = function(columnIndex) {
    return true;
  };

  NullRenderComponent.prototype.addRow = function() {
    return true;
  };

  NullRenderComponent.prototype.addNewBallToColumn = function(ballObject, columnIndex) {
    return true;
  };

  NullRenderComponent.prototype.popBallFromColumn = function(ballObject, columnIndex) {
    return true;
  };

  NullRenderComponent.prototype.pushBallToColumn = function(ballObject, columnIndex) {
    return true;
  };

  NullRenderComponent.prototype.destroyBallFromColumn = function(ballObject, columnIndex) {
    return true;
  };

  NullRenderComponent.prototype.buildCharacterOnColumn = function(columnIndex) {
    return true;
  };

  NullRenderComponent.prototype.showGameOverScreen = function(finalScore, finalDistance) {
    return true;
  };

  NullRenderComponent.prototype.startGameLoop = function(callback) {
    var _this = this;
    return this.gameLoopTimer = setInterval(function() {
      return callback();
    }, 1e3 / 10);
  };

  NullRenderComponent.prototype.stopGameLoop = function() {
    return clearTimeout(this.gameLoopTimer);
  };

  return NullRenderComponent;

})();

DomRenderComponent = (function(_super) {
  var createElementForBall, formatDistance, formatScore, formatTime, getTimestamp, lengthToPx;

  __extends(DomRenderComponent, _super);

  DomRenderComponent.prototype.running = false;

  DomRenderComponent.prototype.progressWidth = 328;

  function DomRenderComponent(parent) {
    this.parent = parent;
    this.gameLoop = __bind(this.gameLoop, this);

    true;
  }

  DomRenderComponent.prototype.start = function() {
    this.parent.show();
    return this.ballsToRemove = [];
  };

  DomRenderComponent.prototype.destroy = function() {
    return this.parent.hide();
  };

  DomRenderComponent.prototype.update = function(deltaLength) {
    var ball, timestamp;
    timestamp = getTimestamp();
    while (this.ballsToRemove.length > 0 && timestamp > this.ballsToRemove[0].timestamp) {
      ball = this.ballsToRemove.shift();
      this.removeBall(ball.id);
    }
    if (-this.expectedOffset > this.offset) {
      this.offset += lengthToPx(deltaLength * 4);
    } else {
      this.offset += lengthToPx(deltaLength);
    }
    this.board.css('top', this.offset);
    return this.columns.css('top', this.columnsOffset);
  };

  DomRenderComponent.prototype.updateScore = function(score) {
    return this.parent.find('.game-score').text(formatScore(score));
  };

  DomRenderComponent.prototype.updateTimer = function(time, totalTime) {
    var remainingTime;
    remainingTime = totalTime - time;
    this.parent.find('.timer .text').text(formatTime(Math.floor(remainingTime)));
    if (time === totalTime) {
      return this.parent.find('.timer .progress').remove();
    } else {
      return this.parent.find('.timer .progress').css('width', (remainingTime / totalTime) * this.progressWidth);
    }
  };

  DomRenderComponent.prototype.buildGameBoard = function(length) {
    var frame, progress, score, time, timer;
    this.length = length;
    this.parent.find('.game-over').hide();
    this.parent.find('.board').remove();
    this.board = $('<div/>');
    this.board.addClass('board');
    this.height = lengthToPx(this.length) + window.innerHeight;
    this.expectedOffset = lengthToPx(this.length) + 200;
    this.board.css('height', this.height);
    this.offset = -lengthToPx(this.length);
    this.board.css('top', this.offset);
    this.columns = $('<div/>');
    this.columns.addClass('columns');
    this.columnsOffset = lengthToPx(this.length) + 270;
    this.columns.css('top', this.columnsOffset);
    this.board.append(this.columns);
    this.parent.append(this.board);
    score = $('<div/>');
    score.addClass('game-score');
    this.parent.append(score);
    timer = $('<div/>');
    timer.addClass('timer');
    progress = $('<div/>');
    progress.addClass('progress');
    timer.append(progress);
    frame = $('<div/>');
    frame.addClass('frame');
    timer.append(frame);
    time = $('<div/>');
    time.addClass('text');
    time.text('0:00');
    timer.append(time);
    return this.parent.append(timer);
  };

  DomRenderComponent.prototype.buildColumn = function(columnIndex) {
    var column;
    column = $('<div />');
    column.addClass('column');
    column.data('x', columnIndex);
    return this.columns.append(column);
  };

  DomRenderComponent.prototype.addNewBallToColumn = function(ballObject, columnIndex) {
    var ball, column;
    ball = createElementForBall(ballObject);
    ball.addClass('new');
    column = this.board.find(".column[data-x='" + columnIndex + "']");
    return column.prepend(ball);
  };

  DomRenderComponent.prototype.addRow = function() {
    this.columnsOffset -= 50;
    return this.expectedOffset -= 50;
  };

  DomRenderComponent.prototype.pushBallToColumn = function(ballObject, columnIndex) {
    var ball, column;
    ball = createElementForBall(ballObject);
    column = this.board.find(".column[data-x='" + columnIndex + "']");
    return column.append(ball);
  };

  DomRenderComponent.prototype.popBallFromColumn = function(ballObject, columnIndex) {
    return this.removeBall(ballObject.id);
  };

  DomRenderComponent.prototype.destroyBallFromColumn = function(ballObject, columnIndex) {
    var ball, column;
    column = this.board.find(".column[data-x='" + columnIndex + "']");
    ball = column.find(".ball[data-id='" + ballObject.id + "']");
    ball.addClass('remove');
    return this.removeBallInMs(ballObject.id, 300);
  };

  DomRenderComponent.prototype.buildCharacterOnColumn = function(columnIndex) {
    var character;
    this.parent.find(".character").remove();
    character = $('<div/>');
    character.addClass('character');
    character.css('left', (columnIndex * 50) - 3);
    return this.parent.append(character);
  };

  DomRenderComponent.prototype.startGameLoop = function(callback) {
    this.gameLoopCallback = callback;
    this.running = true;
    return this.gameLoop();
  };

  DomRenderComponent.prototype.stopGameLoop = function() {
    return this.running = false;
  };

  DomRenderComponent.prototype.showGameOverScreen = function(finalScore, finalDistance, returnToLevelSelectCallback) {
    var gameover,
      _this = this;
    gameover = this.parent.find('.game-over');
    gameover.find('.score').text(formatScore(finalScore));
    gameover.find('.distance').text(formatDistance(finalDistance));
    this.parent.find('.game-over').show();
    return this.parent.on('click', '.game-over button.play-again', function() {
      _this.parent.find('.game-over').hide();
      _this.parent.off('click');
      return returnToLevelSelectCallback();
    });
  };

  DomRenderComponent.prototype.removeBall = function(ballId) {
    var ball;
    ball = this.board.find(".ball[data-id='" + ballId + "']");
    return ball.remove();
  };

  DomRenderComponent.prototype.removeBallInMs = function(ballId, ms) {
    return this.ballsToRemove.push({
      id: ballId,
      timestamp: getTimestamp() + ms
    });
  };

  DomRenderComponent.prototype.gameLoop = function() {
    if (this.running) {
      window.requestAnimationFrame(this.gameLoop);
      return this.gameLoopCallback();
    }
  };

  createElementForBall = function(ballObject) {
    var ball;
    ball = $('<div />');
    ball.addClass('ball');
    ball.data('colour', ballObject.colour);
    return ball.data('id', ballObject.id);
  };

  getTimestamp = function() {
    return new Date().getTime();
  };

  formatScore = function(score) {
    return ("" + score).replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,");
  };

  formatDistance = function(distance) {
    return "" + (distance * 10) + "m";
  };

  formatTime = function(time) {
    var minutes, seconds;
    minutes = Math.floor(time / 60);
    seconds = time % 60;
    if (seconds < 10) {
      seconds = "0" + seconds;
    }
    return "" + minutes + ":" + seconds;
  };

  lengthToPx = function(length) {
    return length * 50;
  };

  return DomRenderComponent;

})(NullRenderComponent);

Ball = (function() {
  var colours, lastBallId, pickColour;

  colours = ['red', 'blue', 'green'];

  lastBallId = 0;

  function Ball() {
    this.id = lastBallId++;
    this.colour = pickColour();
  }

  pickColour = function() {
    return _.first(_.shuffle(colours));
  };

  return Ball;

})();

Character = (function() {

  function Character(options) {
    this.options = options;
    this.column = Math.ceil(this.options.columns / 2);
    true;
  }

  Character.prototype.start = function() {
    return this.moveToColumn(this.column);
  };

  Character.prototype.moveLeft = function() {
    if (this.column > 1) {
      return this.moveToColumn(this.column - 1);
    }
  };

  Character.prototype.moveRight = function() {
    if (this.column < this.options.columns) {
      return this.moveToColumn(this.column + 1);
    }
  };

  Character.prototype.moveToColumn = function(column) {
    this.column = column;
    return this.options.renderComponent.buildCharacterOnColumn(this.column);
  };

  return Character;

})();

Game = (function() {
  var getTimestamp, rowsForLength;

  Game.prototype.running = false;

  Game.prototype.defaults = {
    columns: 7,
    initialRows: 6,
    length: 200,
    inputComponent: new NullInputComponent,
    renderComponent: new NullRenderComponent,
    endGameCallback: null,
    level: null,
    newRowInterval: 5000,
    maxRows: 9,
    totalTime: 120
  };

  function Game(options) {
    this.options = options != null ? options : {};
    this.destroy = __bind(this.destroy, this);

    this.returnToLevelSelect = __bind(this.returnToLevelSelect, this);

    this.gameLoop = __bind(this.gameLoop, this);

    _.defaults(this.options, this.defaults);
  }

  Game.prototype.start = function() {
    this.options.inputComponent.start();
    this.options.renderComponent.start();
    this.buildGameBoard();
    this.lastRenderMs = getTimestamp();
    this.startTime = getTimestamp();
    this.options.renderComponent.startGameLoop(this.gameLoop);
    this.running = true;
    this.distance = 0;
    this.score = 0;
    return this.rowsGenerated = 0;
  };

  Game.prototype.gameLoop = function() {
    var deltaLength, deltaMs, timeElapsed;
    this.distance = this.rowsGenerated - this.countRows();
    if (this.distance < 0) {
      this.distance = 0;
    }
    timeElapsed = (getTimestamp() - this.startTime) / 1000;
    if (timeElapsed > this.options.totalTime) {
      timeElapsed = this.options.totalTime;
      this.triggerGameOver();
    }
    this.options.renderComponent.updateTimer(timeElapsed, this.options.totalTime);
    this.options.inputComponent.update();
    this.handleInput();
    this.handleTimers();
    this.options.renderComponent.updateScore(this.score);
    if (this.countRows() < this.options.initialRows) {
      this.buildRow();
    }
    deltaMs = getTimestamp() - this.lastRenderMs;
    deltaLength = deltaMs * (1 / this.options.newRowInterval);
    this.options.renderComponent.update(deltaLength);
    return this.lastRenderMs = getTimestamp();
  };

  Game.prototype.buildGameBoard = function() {
    var x, _i, _ref;
    this.options.renderComponent.buildGameBoard(this.options.length);
    this.balls = [];
    this.characterBalls = [];
    for (x = _i = 1, _ref = this.options.columns; 1 <= _ref ? _i <= _ref : _i >= _ref; x = 1 <= _ref ? ++_i : --_i) {
      this.buildColumn(x);
    }
    return this.buildCharacter();
  };

  Game.prototype.buildColumn = function(columnIndex) {
    this.options.renderComponent.buildColumn(columnIndex);
    return this.balls.push([]);
  };

  Game.prototype.buildRow = function() {
    var ball, x, _i, _ref;
    if (this.countRows() >= this.options.maxRows) {
      return this.triggerGameOver();
    }
    this.options.renderComponent.addRow();
    for (x = _i = 1, _ref = this.options.columns; 1 <= _ref ? _i <= _ref : _i >= _ref; x = 1 <= _ref ? ++_i : --_i) {
      ball = new Ball();
      this.balls[x - 1].unshift(ball);
      this.options.renderComponent.addNewBallToColumn(ball, x);
    }
    this.rowsGenerated++;
    return this.buildNextRowAt = getTimestamp() + this.options.newRowInterval;
  };

  Game.prototype.buildCharacter = function() {
    this.character = new Character({
      renderComponent: this.options.renderComponent,
      columns: this.options.columns
    });
    return this.character.start();
  };

  Game.prototype.handleInput = function() {
    if (this.options.inputComponent.moveLeft()) {
      this.character.moveLeft();
    } else if (this.options.inputComponent.moveRight()) {
      this.character.moveRight();
    }
    if (this.options.inputComponent.pullBall()) {
      return this.pullBall(this.character.column);
    } else if (this.options.inputComponent.pushBall()) {
      return this.pushBall(this.character.column);
    }
  };

  Game.prototype.pullBall = function(x) {
    var ball, columnBalls, lastPulledBall, pulledColour, rowIndex, _i, _ref;
    columnBalls = this.balls[x - 1];
    pulledColour = columnBalls[columnBalls.length - 1].colour;
    for (rowIndex = _i = _ref = columnBalls.length - 1; _ref <= 0 ? _i <= 0 : _i >= 0; rowIndex = _ref <= 0 ? ++_i : --_i) {
      ball = columnBalls[rowIndex];
      if (ball.colour !== pulledColour) {
        return;
      }
      lastPulledBall = this.characterBalls[0];
      if (!(!lastPulledBall || lastPulledBall.colour === ball.colour)) {
        return;
      }
      ball = columnBalls.pop();
      this.options.renderComponent.popBallFromColumn(ball, x);
      this.characterBalls.push(ball);
    }
  };

  Game.prototype.pushBall = function(x) {
    var ball, columnBalls;
    columnBalls = this.balls[x - 1];
    while (this.characterBalls.length > 0) {
      ball = this.characterBalls.pop();
      columnBalls.push(ball);
      this.options.renderComponent.pushBallToColumn(ball, x);
    }
    return this.findAndDestroyBalls(x);
  };

  Game.prototype.findAndDestroyBalls = function(x) {
    var ball, columnBalls, deleteToIndex, pushedColour, pushedColumnIndex, rowIndex, scoreForMove, searched, toDelete, toSearch, tupleExists, y, _i, _j, _k, _len, _ref, _ref1, _ref2, _ref3;
    pushedColumnIndex = x - 1;
    columnBalls = this.balls[pushedColumnIndex];
    if (columnBalls.length < 3) {
      return;
    }
    pushedColour = columnBalls[columnBalls.length - 1].colour;
    for (rowIndex = _i = _ref = columnBalls.length - 2; _ref <= 0 ? _i <= 0 : _i >= 0; rowIndex = _ref <= 0 ? ++_i : --_i) {
      if (columnBalls[rowIndex].colour !== pushedColour) {
        break;
      }
    }
    if ((columnBalls.length - 1) - rowIndex >= 3) {
      deleteToIndex = rowIndex + 1;
      searched = [];
      toSearch = [];
      toDelete = [];
      for (rowIndex = _j = _ref1 = columnBalls.length - 1; _ref1 <= deleteToIndex ? _j <= deleteToIndex : _j >= deleteToIndex; rowIndex = _ref1 <= deleteToIndex ? ++_j : --_j) {
        toSearch.push([pushedColumnIndex, rowIndex]);
      }
      tupleExists = function(tuple, array) {
        var ax, ay, i, y, _k, _len, _ref2;
        x = tuple[0], y = tuple[1];
        for (i = _k = 0, _len = array.length; _k < _len; i = ++_k) {
          _ref2 = array[i], ax = _ref2[0], ay = _ref2[1];
          if (ax === x && ay === y) {
            return true;
          }
        }
        return false;
      };
      while (toSearch.length > 0) {
        _ref2 = toSearch.shift(), x = _ref2[0], y = _ref2[1];
        if (tupleExists([x, y], searched)) {
          continue;
        }
        searched.push([x, y]);
        if (!this.balls[x] || !this.balls[x][y]) {
          continue;
        }
        if (this.balls[x][y].colour !== pushedColour) {
          continue;
        }
        toDelete.push([x, y]);
        toSearch.push([x + 1, y]);
        toSearch.push([x - 1, y]);
        toSearch.push([x, y + 1]);
        toSearch.push([x, y - 1]);
      }
      scoreForMove = Math.floor(this.rowsGenerated * (toDelete.length / 3)) * 10;
      for (_k = 0, _len = toDelete.length; _k < _len; _k++) {
        _ref3 = toDelete[_k], x = _ref3[0], y = _ref3[1];
        ball = this.balls[x][y];
        this.balls[x].splice(y, 1);
        this.options.renderComponent.destroyBallFromColumn(ball, x + 1);
      }
      return this.score += scoreForMove;
    }
  };

  Game.prototype.handleTimers = function() {
    var timestamp;
    timestamp = getTimestamp();
    if (timestamp > this.buildNextRowAt) {
      return this.buildRow();
    }
  };

  Game.prototype.countRows = function() {
    var columnBalls, rows, _i, _len, _ref;
    rows = 0;
    _ref = this.balls;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      columnBalls = _ref[_i];
      if (columnBalls.length > rows) {
        rows = columnBalls.length;
      }
    }
    return rows;
  };

  Game.prototype.triggerGameOver = function() {
    this.running = false;
    this.options.renderComponent.stopGameLoop();
    return this.options.renderComponent.showGameOverScreen(this.score, this.distance, this.returnToLevelSelect);
  };

  Game.prototype.returnToLevelSelect = function() {
    if (this.options.endGameCallback) {
      return this.options.endGameCallback(this.options.level, this.score, this.distance);
    }
  };

  Game.prototype.destroy = function() {
    this.options.renderComponent.destroy();
    return this.options.inputComponent.destroy();
  };

  getTimestamp = function() {
    return new Date().getTime();
  };

  rowsForLength = function(length) {
    return length;
  };

  return Game;

})();
